<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EDUwaves Invoice Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .main-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin: 20px auto;
            padding: 30px;
            max-width: 1200px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }
        
        .header h1 {
            color: #667eea;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 1.1em;
        }
        
        .form-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }
        
        .form-section h5 {
            color: #667eea;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .search-container {
            position: relative;
        }
        
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .search-result-item {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .search-result-item:hover {
            background-color: #f8f9fa;
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        .book-info {
            font-size: 0.9em;
            color: #666;
        }
        
        .items-table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .items-table th {
            background: #667eea;
            color: white;
            border: none;
            font-weight: 600;
        }
        
        .items-table td {
            vertical-align: middle;
            border-color: #eee;
        }
        
        .remove-item {
            color: #dc3545;
            cursor: pointer;
            font-size: 1.2em;
        }
        
        .remove-item:hover {
            color: #c82333;
        }
        
        .totals-section {
            background: #e3f2fd;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .total-row {
            font-weight: bold;
            font-size: 1.1em;
            color: #1976d2;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .invoice-type-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin: 5px;
        }
        
        .contact-item {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
        }
        
        .contact-item img {
            transition: transform 0.2s ease;
        }
        
        .contact-item:hover img {
            transform: scale(1.1);
        }
        
        .badge-floating { background: #28a745; color: white; }
        .badge-credit { background: #ffc107; color: black; }
        .badge-special { background: #dc3545; color: white; }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner-border {
            color: #667eea;
        }
        
        .bank-selection {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .bank-details {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
        }
        
        .form-check-inline {
            margin-right: 20px;
        }
        
        .form-check-label {
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="main-container">
            <!-- Header -->
            <div class="header">
                <div class="text-center mb-3">
                    <img src="WhatsApp_Image_2025-08-01_at_12.46.28_e1c96073-removebg-preview.png" 
                         alt="EDUwaves Logo" 
                         style="max-height: 80px; max-width: 200px;">
                </div>
                <div class="text-center mb-2">
                    <p class="slogan-text" style="font-style: italic; color: #666; font-size: 0.9em; margin: 0;">
                        ...global positioning for the african child
                    </p>
                </div>
                <h1><i class="fas fa-file-invoice"></i> EDUwaves Invoice Generator</h1>
                <p>Professional Invoice Creation System</p>
                <a href="/reports" class="btn btn-outline-primary btn-sm">
                    <i class="fas fa-chart-bar"></i> View Reports
                </a>
                
                <!-- Contact Information -->
                <div class="contact-info text-center mt-3" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef;">
                    <div class="row">
                        <div class="col-md-3 col-sm-6 mb-2">
                            <div class="contact-item">
                                <img src="images/whatsapp.png" alt="WhatsApp" style="width: 20px; height: 20px; margin-right: 8px; vertical-align: middle;">
                                <small><strong>WhatsApp:</strong><br>09025977776</small>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6 mb-2">
                            <div class="contact-item">
                                <i class="fas fa-phone text-primary" style="margin-right: 8px;"></i>
                                <small><strong>Call:</strong><br>+234 803 086 7910<br>07066483007</small>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6 mb-2">
                            <div class="contact-item">
                                <img src="images/web.png" alt="Website" style="width: 20px; height: 20px; margin-right: 8px; vertical-align: middle;">
                                <small><strong>Website:</strong><br>www.eduwavespublishers.com</small>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6 mb-2">
                            <div class="contact-item">
                                <img src="images/gmail-logo.png" alt="Gmail" style="width: 20px; height: 20px; margin-right: 8px; vertical-align: middle;">
                                <small><strong>Email:</strong><br>eduwavespl@gmail.com</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Warning Messages -->
            <div class="alert alert-warning" role="alert">
                <h6><i class="fas fa-exclamation-triangle"></i> Important Notice</h6>
                <p class="mb-1"><strong>Sales Representative Changes:</strong> Some sales representatives have been changed but have not been updated in the database. Please make sure to cross-check the sales manager information before generating the invoice.</p>
            </div>

            <form id="invoiceForm">
                <!-- Invoice Type Selection -->
                <div class="form-section">
                    <h5><i class="fas fa-tags"></i> Invoice Type</h5>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="invoiceType" id="floatingStock" value="floating" checked>
                                <label class="form-check-label" for="floatingStock">
                                    <span class="invoice-type-badge badge-floating">Floating Stock</span>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="invoiceType" id="creditSchool" value="credit">
                                <label class="form-check-label" for="creditSchool">
                                    <span class="invoice-type-badge badge-credit">Credit School</span>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="invoiceType" id="specialMarket" value="special">
                                <label class="form-check-label" for="specialMarket">
                                    <span class="invoice-type-badge badge-special">Special Market</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Customer Information -->
                <div class="form-section">
                    <h5><i class="fas fa-building"></i> Customer Information</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="search-container">
                                <label for="customerSearch" class="form-label">School Name</label>
                                <input type="text" class="form-control" id="customerSearch" placeholder="Type school name to search...">
                                <div id="customerResults" class="search-results" style="display: none;"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="customerPhone" class="form-label">Phone Number</label>
                            <input type="text" class="form-control" id="customerPhone" placeholder="Enter phone number">
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label for="customerAddress" class="form-label">Address</label>
                            <input type="text" class="form-control" id="customerAddress" placeholder="Enter customer address">
                        </div>
                        <div class="col-md-6">
                            <label for="salesManager" class="form-label">Sales Manager</label>
                            <input type="text" class="form-control" id="salesManager" placeholder="Enter sales manager name">
                        </div>
                    </div>
                </div>

                <!-- Bank Selection -->
                <div class="form-section">
                    <h5><i class="fas fa-university"></i> Bank Details</h5>
                    <div class="alert alert-info">
                        <strong><i class="fas fa-info-circle"></i> Banking Options:</strong>
                        Select the appropriate payment method. 
                        <strong>Cash Sales</strong> uses Zenith Bank, 
                        and <strong>Special Markets</strong> use Globus Bank.
                    </div>
                    <div class="bank-selection">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="bankSelection" id="cashSales" value="cash" checked>
                                    <label class="form-check-label" for="cashSales">
                                        <strong>CASH SALES</strong> (Zenith Bank)
                                    </label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="bankSelection" id="specialBank" value="special">
                                    <label class="form-check-label" for="specialBank">
                                        <strong>SPECIAL MARKETS</strong> (Globus Bank)
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bank-details mt-3">
                        <div class="row">
                            <div class="col-md-4">
                                <label class="form-label"><strong>Account Name:</strong></label>
                                <div class="form-control-plaintext" id="accountName">EDUWAVES PUBLISHERS LTD</div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label"><strong>Bank Name:</strong></label>
                                <div class="form-control-plaintext" id="bankName">ZENITH BANK</div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label"><strong>Account Number:</strong></label>
                                <div class="form-control-plaintext" id="accountNumber">1229600064</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Book Search and Selection -->
                <div class="form-section">
                    <h5><i class="fas fa-book"></i> Add Books</h5>
                    <div class="search-container">
                        <label for="bookSearch" class="form-label">Search Books</label>
                        <input type="text" class="form-control" id="bookSearch" placeholder="Type book title, subject, or grade to search...">
                        <div id="bookResults" class="search-results" style="display: none;"></div>
                    </div>
                </div>

                <!-- Items Table -->
                <div class="form-section">
                    <h5><i class="fas fa-list"></i> Invoice Items</h5>
                    <div class="table-responsive">
                        <table class="table items-table">
                            <thead>
                                <tr>
                                    <th>S.No.</th>
                                    <th>Book Code</th>
                                    <th>Title</th>
                                    <th>Rate (N)</th>
                                    <th>Qty.</th>
                                    <th>Gross Amount (N)</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="itemsTableBody">
                                <tr id="noItemsRow">
                                    <td colspan="7" class="text-center text-muted">No items added yet. Search and add books above.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Discount and Totals -->
                <div class="totals-section">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="discountPercent" class="form-label">Discount Percentage (%)</label>
                            <input type="number" class="form-control" id="discountPercent" value="0" min="0" max="100" step="0.1">
                        </div>
                        <div class="col-md-6">
                            <div class="row">
                                <div class="col-6">
                                    <label class="form-label">Total Quantity</label>
                                    <div class="form-control-plaintext" id="totalQuantity">0</div>
                                </div>
                                <div class="col-6">
                                    <label class="form-label">Gross Total (N)</label>
                                    <div class="form-control-plaintext" id="grossTotal">N0.00</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Discount Amount (N)</label>
                            <div class="form-control-plaintext" id="discountAmount">N0.00</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label total-row">Net Amount Payable (N)</label>
                            <div class="form-control-plaintext total-row" id="netTotal">N0.00</div>
                        </div>
                    </div>
                </div>

                <!-- Generate Invoice Button -->
                <div class="text-center mt-4">
                    <button type="submit" class="btn btn-primary btn-lg me-3">
                        <i class="fas fa-file-pdf"></i> Generate Invoice PDF
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-lg" onclick="clearForm()">
                        <i class="fas fa-eraser"></i> Clear Form
                    </button>
                </div>

                <!-- Bottom Warning -->
                <div class="alert alert-info mt-3" role="alert">
                    <h6><i class="fas fa-info-circle"></i> Price Notice</h6>
                    <p class="mb-0"><strong>Kingdom Heritage School:</strong> The prices for Kingdom Heritage School differ from the standard catalog. Please make sure to check and verify the correct rates before generating the invoice.</p>
                </div>

                <!-- Loading Indicator -->
                <div class="loading" id="loadingIndicator">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Generating...</span>
                    </div>
                    <p class="mt-2">Generating your invoice...</p>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let selectedItems = [];
        let itemCounter = 1;

        // Bank details
        const bankDetails = {
            cash: {
                name: "ZENITH BANK",
                accountNumber: "1229600064",
                regions: "Cash Sales"
            },
            special: {
                name: "GLOBUS BANK", 
                accountNumber: "1000429262",
                regions: "Special Markets"
            }
        };

        // Book search functionality
        document.getElementById('bookSearch').addEventListener('input', function() {
            const query = this.value;
            if (query.length < 2) {
                document.getElementById('bookResults').style.display = 'none';
                return;
            }

            fetch(`/api/books/search?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(books => {
                    const resultsDiv = document.getElementById('bookResults');
                    resultsDiv.innerHTML = '';
                    
                    if (books.length === 0) {
                        resultsDiv.innerHTML = '<div class="search-result-item">No books found</div>';
                    } else {
                        books.forEach(book => {
                            const item = document.createElement('div');
                            item.className = 'search-result-item';
                            item.innerHTML = `
                                <div><strong>${book.title}</strong></div>
                                <div class="book-info">${book.book_code} | ${book.grade} | ${book.subject} | N${book.price.toLocaleString()}</div>
                            `;
                            item.addEventListener('click', (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                addBookToInvoice(book);
                            });
                            resultsDiv.appendChild(item);
                        });
                    }
                    
                    resultsDiv.style.display = 'block';
                });
        });

        // Hide search results when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-container')) {
                document.getElementById('bookResults').style.display = 'none';
                document.getElementById('customerResults').style.display = 'none';
            }
        });

        // Customer search functionality
        document.getElementById('customerSearch').addEventListener('input', function() {
            const invoiceType = document.querySelector('input[name="invoiceType"]:checked').value;
            
            // For floating stock, don't allow typing in customer search (it's readonly)
            if (invoiceType === 'floating') {
                document.getElementById('customerResults').style.display = 'none';
                return;
            }
            
            const query = this.value;
            if (query.length < 2) {
                document.getElementById('customerResults').style.display = 'none';
                return;
            }

            fetch(`/api/schools/search?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(schools => {
                    const resultsDiv = document.getElementById('customerResults');
                    resultsDiv.innerHTML = '';
                    
                    if (schools.length === 0) {
                        resultsDiv.innerHTML = '<div class="search-result-item">No schools found</div>';
                    } else {
                        schools.forEach(school => {
                            const item = document.createElement('div');
                            item.className = 'search-result-item';
                            item.innerHTML = `
                                <div><strong>${school.name}</strong></div>
                                <div class="book-info">${school.sm_name} | ${school.phone}</div>
                            `;
                            item.addEventListener('click', (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                selectCustomer(school);
                            });
                            resultsDiv.appendChild(item);
                        });
                    }
                    
                    resultsDiv.style.display = 'block';
                });
        });

        // Add book to invoice
        function addBookToInvoice(book) {
            // Check if book already exists
            const existingItem = selectedItems.find(item => item.book_code === book.book_code);
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                selectedItems.push({
                    ...book,
                    quantity: 1
                });
            }
            
            updateItemsTable();
            updateTotals();
            
            // Clear search and results completely
            document.getElementById('bookSearch').value = '';
            document.getElementById('bookResults').innerHTML = '';
            document.getElementById('bookResults').style.display = 'none';
        }

        // Clear form function
        function clearForm() {
            // Clear selected items
            selectedItems = [];
            updateItemsTable();
            updateTotals();
            
            // Clear search fields
            document.getElementById('bookSearch').value = '';
            document.getElementById('bookResults').innerHTML = '';
            document.getElementById('bookResults').style.display = 'none';
            
            document.getElementById('customerSearch').value = '';
            document.getElementById('customerResults').innerHTML = '';
            document.getElementById('customerResults').style.display = 'none';
            
            // Clear customer details
            document.getElementById('customerPhone').value = '';
            document.getElementById('customerAddress').value = '';
            document.getElementById('salesManager').value = '';
            
            // Reset discount
            document.getElementById('discountPercent').value = '0';
            
            // Reset to default invoice type (credit school)
            document.getElementById('creditSchool').checked = true;
            
            // Reset bank selection to cash sales
            document.getElementById('cashSales').checked = true;
            updateBankDetails();
            
            // Make fields editable for credit school
            document.getElementById('customerSearch').readOnly = false;
            document.getElementById('salesManager').readOnly = false;
            document.getElementById('customerSearch').placeholder = "Type school name to search...";
            document.getElementById('salesManager').placeholder = "Enter sales manager name";
        }

        // Select customer
        function selectCustomer(school) {
            const invoiceType = document.querySelector('input[name="invoiceType"]:checked').value;
            
            if (invoiceType === 'floating') {
                // For floating stock, only update sales manager and phone, keep customer name as "Floating Stock"
                document.getElementById('salesManager').value = school.sm_name;
                document.getElementById('customerPhone').value = school.phone;
                document.getElementById('customerResults').style.display = 'none';
            } else {
                // For other types, update all fields
                document.getElementById('customerSearch').value = school.name;
                document.getElementById('customerPhone').value = school.phone;
                document.getElementById('salesManager').value = school.sm_name;
                document.getElementById('customerResults').style.display = 'none';
                
                // Show a note that fields are editable
                if (!document.getElementById('editableNote')) {
                    const note = document.createElement('div');
                    note.id = 'editableNote';
                    note.className = 'alert alert-info mt-2';
                    note.innerHTML = '<small><i class="fas fa-info-circle"></i> <strong>Note:</strong> All contact fields are editable. You can modify any information as needed.</small>';
                    document.querySelector('.form-section').appendChild(note);
                }
            }
        }

        // Update items table
        function updateItemsTable() {
            const tbody = document.getElementById('itemsTableBody');
            tbody.innerHTML = '';
            
            if (selectedItems.length === 0) {
                tbody.innerHTML = '<tr id="noItemsRow"><td colspan="7" class="text-center text-muted">No items added yet. Search and add books above.</td></tr>';
            } else {
                selectedItems.forEach((item, index) => {
                    const row = document.createElement('tr');
                    const grossAmount = item.quantity * item.price;
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${item.book_code}</td>
                        <td>${item.title}</td>
                        <td>
                            <input type="number" class="form-control form-control-sm" value="${item.price}" 
                                   min="0" step="0.01" onchange="updateRate(${index}, this.value)">
                        </td>
                        <td>
                            <input type="number" class="form-control form-control-sm" value="${item.quantity}" 
                                   min="1" onchange="updateQuantity(${index}, this.value)">
                        </td>
                        <td>N${grossAmount.toLocaleString()}</td>
                        <td><i class="fas fa-trash remove-item" onclick="removeItem(${index})"></i></td>
                    `;
                    tbody.appendChild(row);
                });
            }
            
            calculateTotals();
        }

        // Update quantity
        function updateQuantity(index, newQuantity) {
            selectedItems[index].quantity = parseInt(newQuantity) || 1;
            updateItemsTable();
        }

        // Update rate
        function updateRate(index, newRate) {
            selectedItems[index].price = parseFloat(newRate) || 0;
            updateItemsTable();
        }

        // Remove item
        function removeItem(index) {
            selectedItems.splice(index, 1);
            updateItemsTable();
        }

        // Calculate totals
        function calculateTotals() {
            const totalQuantity = selectedItems.reduce((sum, item) => sum + item.quantity, 0);
            const grossTotal = selectedItems.reduce((sum, item) => sum + (item.quantity * item.price), 0);
            const discountPercent = parseFloat(document.getElementById('discountPercent').value) || 0;
            const discountAmount = grossTotal * (discountPercent / 100);
            const netTotal = grossTotal - discountAmount;

            document.getElementById('totalQuantity').textContent = totalQuantity;
            document.getElementById('grossTotal').textContent = `N${grossTotal.toLocaleString()}`;
            document.getElementById('discountAmount').textContent = `N${discountAmount.toLocaleString()}`;
            document.getElementById('netTotal').textContent = `N${netTotal.toLocaleString()}`;
        }

        // Discount change handler
        document.getElementById('discountPercent').addEventListener('input', calculateTotals);

        // Invoice type change handler
        document.querySelectorAll('input[name="invoiceType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const invoiceType = this.value;
                const customerSearch = document.getElementById('customerSearch');
                const salesManager = document.getElementById('salesManager');
                
                if (invoiceType === 'special') {
                    // For special market, allow manual input
                    customerSearch.placeholder = "Enter school name manually...";
                    salesManager.placeholder = "Enter sales manager name...";
                    
                    // Clear existing values
                    customerSearch.value = '';
                    salesManager.value = '';
                    document.getElementById('customerPhone').value = '';
                    
                    // Auto-select Special Markets Bank for special market
                    document.getElementById('specialBank').checked = true;
                    updateBankDetails();
                } else if (invoiceType === 'floating') {
                    // For floating stock, auto-fill customer name but keep sales manager editable
                    customerSearch.value = 'Floating Stock';
                    salesManager.value = '';
                    salesManager.placeholder = 'Enter sales manager name...';
                    document.getElementById('customerPhone').value = '';
                    
                    // Make customer name readonly but sales manager editable for floating stock
                    customerSearch.readOnly = true;
                    salesManager.readOnly = false;
                    
                    // Auto-select Cash Sales Bank for floating stock
                    document.getElementById('cashSales').checked = true;
                    updateBankDetails();
                } else {
                    // For credit school, use search functionality
                    customerSearch.placeholder = "Type school name to search...";
                    salesManager.placeholder = "Enter sales manager name";
                    
                    // Make fields editable for credit school
                    customerSearch.readOnly = false;
                    salesManager.readOnly = false;
                    
                    // Clear existing values
                    customerSearch.value = '';
                    salesManager.value = '';
                    document.getElementById('customerPhone').value = '';
                    
                    // Auto-select Cash Sales Bank for normal operations (default)
                    document.getElementById('cashSales').checked = true;
                    updateBankDetails();
                }
            });
        });

        // Bank selection change handler
        document.querySelectorAll('input[name="bankSelection"]').forEach(radio => {
            radio.addEventListener('change', updateBankDetails);
        });

        // Update bank details function
        function updateBankDetails() {
            const selectedBank = document.querySelector('input[name="bankSelection"]:checked').value;
            const bankInfo = bankDetails[selectedBank];
            
            document.getElementById('bankName').textContent = bankInfo.name;
            document.getElementById('accountNumber').textContent = bankInfo.accountNumber;
        }

        // Form submission
        document.getElementById('invoiceForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (selectedItems.length === 0) {
                alert('Please add at least one book to the invoice.');
                return;
            }
            
            const selectedBank = document.querySelector('input[name="bankSelection"]:checked').value;
            const bankInfo = bankDetails[selectedBank];
            
            const formData = {
                invoice_type: document.querySelector('input[name="invoiceType"]:checked').value,
                customer_name: document.getElementById('customerSearch').value,
                customer_phone: document.getElementById('customerPhone').value,
                customer_address: document.getElementById('customerAddress').value,
                sales_manager: document.getElementById('salesManager').value,
                items: selectedItems,
                discount_percent: parseFloat(document.getElementById('discountPercent').value) || 0,
                bank_name: bankInfo.name,
                account_number: bankInfo.accountNumber
            };
            
            // Show loading
            document.getElementById('loadingIndicator').style.display = 'block';
            
            fetch('/api/generate-invoice', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('loadingIndicator').style.display = 'none';
                
                if (data.success) {
                    alert(`Invoice generated successfully!\nInvoice Number: ${data.invoice_number}`);
                    
                    // Create and download PDF from base64 data
                    const pdfData = data.pdf_data;
                    const pdfBlob = new Blob([Uint8Array.from(atob(pdfData), c => c.charCodeAt(0))], {
                        type: 'application/pdf'
                    });
                    
                    const url = URL.createObjectURL(pdfBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `invoice_${data.invoice_number.replace('/', '_')}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    // Clear form for next invoice
                    clearForm();
                } else {
                    alert('Error generating invoice. Please try again.');
                }
            })
            .catch(error => {
                document.getElementById('loadingIndicator').style.display = 'none';
                console.error('Error:', error);
                alert('Error generating invoice. Please try again.');
            });
        });
    </script>
</body>
</html>
